---
title: "1 data exploration"
author: "Paul Hively"
date: "August 4, 2016"
output: html_document
---

The goal of this project is to identify covariates and factors associated with scholarship funds. A predictive model would be nice, but for now my main focus is explanation.

Load the libraries and data and do some cleanup.

```{r, message=F, warning=F, cache=F}
source("LIBRARIES.R")
dat <- read.csv("data\\2016-08-09 ABEM FY17.csv", header=T, stringsAsFactors=F)

## Data cleanup
mdat <- dat %>%
  # Select desired columns
  select(student.gifts = Giving.Student.Support,
         id = Entity.ID,
         employ.yrs = Employ.Years.At.Current.Company,
         nice.title = Bus.Title.High.Lvl,
         gift.cap = Gift.Capacity.Numerical.Amt..CR.,
         fys.giving = Giving.FYs.of.Giving,
         fys.recent = Giving.FY.in.Last.5,
         first.gift = Giving.First.Trans.Amt,
         af.giving = Giving.Booth.AF.Gifts,
         spouse = Spouse.Married.UC.Booth,
         known.to = Rel.Known.Tos.Count,
         stewardee = Alloc.Stewardee.Student.Support,
         committees = Committee.in.Last.3.FY,
         vols = Vol.Acts..BUS.,
         speak = Events.Vol.Speaker,
         stu.acts = Student.Acts..BUS.,
         lead.facil = Student.Acts.LEAD.Facilitator,
         stu.supp = Vol.Act.Student.Supporter,
         scholarship = Scholarships.Count,
         events = Events.Attended..BUS.,
         events.stu = Events.Attended..BUS..Student,
         nonprofit = Nonprofit.Leadership.Flag) %>%
  # Convert string columns to factor
  mutate(spouse = as.factor(spouse)) %>%
  # Convert string columns to factor
  mutate(nice.title = as.factor(nice.title),
         spouse = as.factor(spouse),
         nonprofit = as.factor(nonprofit)) %>%
  # Convert currency columns to numeric
  CurrencyToNumeric(fields = c("student.gifts", "gift.cap", "first.gift", "af.giving"))
# Replace NAs with 0
mdat[is.na(mdat)] <- 0

# View random sample of resulting data
set.seed(123)
rand <- sample(1:nrow(mdat), nrow(mdat))
str(mdat %>% select(-id) %>% slice(rand))
```

Here, `student.gifts` (dollars given to student support) is the outcome variable being measured. I've (semi-arbitrarily) chosen a few variables to examine based on my own judgement and suggestions from the rest of the team. Begin by looking for plausible transformations.

```{r, echo=F, message=F, warning=F, cache=F}
## Drop $0 donors
ggdat <- mdat %>% filter(student.gifts > 0)
# Base, and 3 basic transformations
ggplot(ggdat, aes(x=student.gifts)) + geom_histogram(alpha=.5, binwidth=10000) + labs(title="Student support giving, untransformed") + scale_x_continuous(labels=scales::dollar)
ggplot(ggdat, aes(x=student.gifts)) + geom_histogram(alpha=.5, binwidth=100) + labs(title="Student support giving, square root transformation") + scale_x_sqrt(labels=scales::dollar)
ggplot(ggdat, aes(x=student.gifts)) + geom_histogram(alpha=.5, binwidth=.25) + labs(title=expression(paste("Student support giving, ", log[10], " transformation"))) + scale_x_log10(labels=scales::dollar, breaks=10^(0:7), minor_breaks=NULL)

# Log 10 transformation is the best
mdat <- mdat %>% mutate(student.gifts.lt = log(student.gifts, base=10))
ggdat <- mdat %>% filter(student.gifts > 0)
```

As usual, the $\text{log}_{10}$ transformation looks good. It does require dropping non-donors; one thought is to fit an explanatory model only to (a random sample of) those people who have made gifts and make predictions for the rest of the population. Of course, there's no particular reason to think donors and non-donors are comparable, but it's a starting point.

Exploring the factors and covariates:

```{r, echo=F, message=F, warning=F, cache=F}
# Tabulation of spouses
kable(
  mdat %>% mutate(count = 1) %>% group_by(spouse) %>% summarise(count = sum(count), mean.giving = mean(student.gifts)),
  digits=2
)
kable(
  mdat %>% filter(student.gifts > 0) %>% mutate(count = 1) %>% group_by(spouse) %>% summarise(donor.count = sum(count), mean.donor.giving = mean(student.gifts)),
  digits=2
)

# Histogram of transformed giving by spouses
ggplot(ggdat, aes(x=student.gifts, y=..density..)) + geom_density() + geom_histogram(alpha=.5, binwidth=.25) + labs(title=expression(paste("Student support giving, ", log[10], " transformation"))) + scale_x_log10(labels=scales::dollar, breaks=10^(0:7), minor_breaks=NULL) + facet_grid(spouse ~ .)

# Boxplot of giving by spouses
ggplot(ggdat, aes(x=spouse, y=student.gifts)) + geom_boxplot(alpha=.5) + scale_y_log10(labels=scales::dollar, breaks=10^(0:7), minor_breaks=NULL)
```

Ignoring other covariates, married donors are more generous than unmarried ones. On to the numerical variables.

```{r, echo=F, message=F, warning=F, cache=F}
# Axis formatting
gg.y.logdollar <- list(scale_y_log10(labels=scales::dollar, breaks=10^(0:7), minor_breaks=NULL))
gg.x.logdollar <- list(scale_x_log10(labels=scales::dollar, breaks=10^(0:7), minor_breaks=NULL))
gg.fitline <- list(stat_smooth(method=lm, alpha=.25))

# Length of employment
ggplot(ggdat, aes(x=employ.yrs, y=student.gifts)) + geom_point() + gg.y.logdollar + gg.fitline
# Nice title (high-level)
ggplot(ggdat, aes(x=factor(nice.title), y=student.gifts)) + geom_boxplot(alpha=.5) + gg.y.logdollar
```

Being employed longer and having a fancy job title is associated with increased giving to student causes, ignoring other covariates. (I'm going to stop writing that but it's assumed for the rest.)

```{r, echo=F, message=F, warning=F, cache=F}
# Gift capacity
ggplot(ggdat, aes(x=gift.cap, y=student.gifts)) + geom_point(alpha=.5) + gg.x.logdollar + gg.y.logdollar + gg.fitline
# Total FYs of giving
ggplot(ggdat, aes(x=fys.giving, y=student.gifts)) + geom_point(alpha=.5) + gg.y.logdollar + gg.fitline
# Recent FYs (last 5) of giving
ggplot(ggdat, aes(x=fys.recent, y=student.gifts)) + geom_point() + gg.y.logdollar + gg.fitline
# First gift amount
ggplot(ggdat, aes(x=first.gift, y=student.gifts)) + geom_point() + gg.y.logdollar + gg.x.logdollar + gg.fitline
# Years of AF giving
ggplot(ggdat, aes(x=af.giving, y=student.gifts)) + geom_point() + gg.y.logdollar + gg.fitline
```

Previous giving and gift capacity are strongly associated with other giving behaviors, as has been repeatedly found in the past. In particular, note the correlation between first gift and student giving amounts -- there are a few interesting patterns apaprent, such as the cluster of points around $x=y$ and shrinking variances as first gift amounts increase.

```{r, echo=F, message=F, warning=F, cache=F}
# Known to count
ggplot(ggdat, aes(x=known.to, y=student.gifts)) + geom_point() + gg.y.logdollar + gg.fitline + scale_x_sqrt() + labs(x="known.to (sqrt scale)")
# Number of student allocations as a stewardee
ggplot(ggdat, aes(x=stewardee, y=student.gifts)) + geom_point() + gg.y.logdollar + gg.fitline
# Number of committees
ggplot(ggdat, aes(x=committees, y=student.gifts)) + geom_point() + gg.y.logdollar + gg.fitline
# Number of volunteer activities
ggplot(ggdat, aes(x=vols, y=student.gifts)) + geom_point() + gg.y.logdollar + gg.fitline
# Number of speaking engagements
ggplot(ggdat, aes(x=speak, y=student.gifts)) + geom_point() + gg.y.logdollar + gg.fitline
# Number of student activities
ggplot(ggdat, aes(x=stu.acts, y=student.gifts)) + geom_point() + gg.y.logdollar + gg.fitline
# Lead Facilitator indicator
ggplot(ggdat, aes(x=as.factor(lead.facil), y=student.gifts)) + geom_boxplot(alpha=.5) + gg.y.logdollar
# Student supporter indicator
ggplot(ggdat, aes(x=as.factor(stu.supp), y=student.gifts)) + geom_boxplot(alpha=.5) + gg.y.logdollar
# Booth events attended
ggplot(ggdat, aes(x=events, y=student.gifts)) + geom_point() + gg.y.logdollar + gg.fitline
# Booth student events attended
ggplot(ggdat, aes(x=events.stu, y=student.gifts)) + geom_point() + gg.y.logdollar + gg.fitline
# Nonprofit board membership
ggplot(ggdat, aes(x=as.factor(nonprofit), y=student.gifts)) + geom_boxplot(alpha=.5) + gg.y.logdollar
```

A bit of a mixed bag here: people who are involved as *students* are not more likely to be donors, but those who are involved as alumni are. In particular, note the difference between student and alumni event attendance. Many of these are counts and should be transformed (sqrt) if used in a lm or glm.

```{r, echo=F, message=F, warning=F, cache=F}
# Number of scholarships
ggplot(ggdat, aes(x=scholarship, y=student.gifts)) + geom_point() + gg.y.logdollar + gg.fitline
```

And here's the big surprise: no association, or even slightly negative, between receiving scholarships and giving to student causes. I expect that receiving scholarships is associated with age, for example, so there might still be a story there.

